<% layout("/layouts/boilerplate") %>
<body class="bg-light p-4">

<div class="container mt-4">

  <!-- LISTING CARD ---- ONLY MAIN INFO HERE -->
  <div class="card shadow-lg border-0 mx-auto" style="max-width: 650px; border-radius: 15px;">

    <!-- IMAGE -->
    <img 
      src="<%= listing.image %>" 
      class="card-img-top"
      style="height: 320px; object-fit: cover; border-radius: 15px 15px 0 0;"
      alt="Room Image"
    >

    <div class="card-body">

      <!-- TITLE -->
      <h2 class="card-title mb-3 fw-bold text-dark">
        <%= listing.title %>
      </h2>

      <!-- OWNER NAME -->
      <h4 class="mb-3 fw-bold text-dark">
        Owner:
        <span class="text-dark">
          <%= listing.owner ? listing.owner.username : "Unknown" %>
        </span>
      </h4>

      <!-- DETAILS -->
      <ul class="list-group list-group-flush mb-3">
        <li class="list-group-item"><strong>Description:</strong> <%= listing.description %></li>
        <li class="list-group-item"><strong>Price:</strong> ‚Çπ <%= listing.price.toLocaleString("en-IN") %></li>
        <li class="list-group-item"><strong>Location:</strong> <%= listing.location %></li>
        <li class="list-group-item"><strong>Country:</strong> <%= listing.country %></li>
      </ul>

      <% if (currUser && listing.owner && currUser._id.toString() === listing.owner._id.toString()) { %>
      <!-- BUTTONS -->
      <div class="d-flex gap-3 mt-3">
        <form action="/listings/<%= listing._id %>/edit" method="GET" class="w-50">
          <button type="submit" class="btn btn-primary w-100 btn-sm">‚úèÔ∏è Edit</button>
        </form>

        <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="w-50">
          <button type="submit" class="btn btn-danger w-100 btn-sm">üóë Delete</button>
        </form>
      </div>
      <% } %>
    </div>
  </div>
  <!-- END CARD -->

<br>
<br>

<% if (currUser) { %>
<!-- ADD REVIEW -->
<div class="object-fit-contain border rounded" style="border-radius: 15px;">
  <h4 class="fw-bold mb-3" style="color: black;">&#9997; Add a Review</h4>

  <form action="/listings/<%= listing._id %>/reviews" method="post" class="p-4 shadow-lg rounded bg-white" style="max-width: 600px; margin: auto;">
    <!-- RATING -->
    <label class="fw-bold">Rating: <span id="ratingValue">3</span> ‚≠ê</label>
    <input type="range" class="form-range" min="1" max="5" step="1"
           name="review[rating]" value="3"
           oninput="document.getElementById('ratingValue').innerText = this.value">

    <!-- COMMENT -->
    <textarea class="form-control mt-3" name="review[comment]" rows="3"
              placeholder="Write your review..." required></textarea>

    <button class="btn btn-success mt-3 w-100">Submit Review</button>
  </form>
</div>
<% } %>

<!-- RATINGS SUMMARY -->
<div class="container mt-5">
  <h3 class="fw-bold mb-4">Ratings & Reviews</h3>

  <%
    let total = listing.reviews.length;
    let sum = listing.reviews.reduce((a,b)=>a+b.rating, 0);
    let avg = total ? (sum/total).toFixed(1) : 0;
  %>

  <div class="row bg-white shadow-sm p-4 rounded mb-4">

    <!-- AVG RATING -->
    <div class="col-md-4 text-center border-end">
      <div class="display-4 fw-bold"><%= avg %> ‚òÖ</div>
      <div class="text-success fw-bold"><%= total ? "Fabulous" : "No ratings" %></div>
      <div class="text-muted"><%= total %> ratings</div>
    </div>

    <!-- PROGRESS BARS -->
    <div class="col-md-8 ps-4">
      <% const counts=[0,0,0,0,0,0]; listing.reviews.forEach(r=>counts[r.rating]++); %>

      <% for(let i=5;i>=1;i--){ 
           let percent = total ? (counts[i]/total)*100 : 0;
      %>
        <div class="d-flex align-items-center mb-2">
          <div style="width: 30px;"><%= i %>‚òÖ</div>

          <div class="progress flex-grow-1" style="height: 8px;">
            <div class="progress-bar bg-warning" style="width: <%= percent %>%"></div>
          </div>

          <div class="ms-2 text-muted"><%= percent.toFixed(0) %>%</div>
        </div>
      <% } %>
    </div>

  </div>

<!-- ALL REVIEWS -->
<h4 class="fw-bold mb-3">All Reviews</h4>

<% if(total === 0){ %>
  <p class="text-muted">No reviews yet.</p>
<% } %>

<% listing.reviews.forEach(r => { %>
  <div class="card mb-3 shadow-sm border-0 position-relative">
    <div class="card-body">

      <!-- DELETE BUTTON ONLY FOR REVIEW OWNER -->
      <% if (currUser && r.author && currUser._id.toString() === r.author._id.toString()) { %>
        <form 
          action="/listings/<%= listing._id %>/reviews/<%= r._id %>?_method=DELETE" 
          method="POST"
          class="position-absolute"
          style="top: 15px; right: 15px;"
        >
          <button 
            class="btn btn-sm btn-danger rounded-circle d-flex align-items-center justify-content-center"
            style="width:32px; height:32px;"
          >
            <i class="fa-solid fa-trash"></i>
          </button>
        </form>
      <% } %>

      <!-- AUTHOR NAME + DATE -->
      <p class="mb-1">
        <strong>&#128100; <%= r.author ? r.author.username : "Unknown User" %></strong>
        <span class="text-muted" style="font-size: 0.9rem;">
          ‚Ä¢ <%= new Date(r.createdAt).toLocaleDateString() %>
        </span>
      </p>

      <!-- Stars -->
      <div class="mb-2">
        <% for(let i=1;i<=5;i++){ %>
          <% if(i<=r.rating){ %>
            <i class="fa-solid fa-star text-warning"></i>
          <% } else { %>
            <i class="fa-regular fa-star text-muted"></i>
          <% } %>
        <% } %>
      </div>

      <!-- Comment -->
      <p><%= r.comment %></p>

    </div>
  </div>
<% }) %>

</div>

</body>
</html>
